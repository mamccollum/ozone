#!/bin/sh
set -eu

# metadata - edit per package
NAME=tzdb
VER=2025b
PKGNAME=OZtzdb
PREFIX=/opt/oz
TARBALL=${NAME}-${VER}.tar.lz
TARBALL_URL="http://data.iana.org/time-zones/releases/${TARBALL}"
# optional: set correct sha256 or leave empty to skip check
TARBALL_SHA256=""
PATCHDIR="$RECIPEDIR/patches"
HOOKSDIR="$RECIPEDIR/hooks"

CPPFLAGS="-I${PREFIX}/include -DSUPPORT_POSIX2008 -DTZDIR=\\\"${PREFIX}/share/zoneinfo\\\""
CFLAGS="-std=gnu11"
LDFLAGS="-L${PREFIX}/lib"

: "${TOP:=$(pwd)}"
: "${WORK:=${WORK:-${TOP}/build/${NAME}}}"
: "${STAGING:=${STAGING:-${TOP}/build/${NAME}-staging}}"

mkdir -p "${TOP}/src" "${WORK}" "${STAGING}"

fetch() {
	cd "${TOP}/src"
	if [ ! -f "${TARBALL}" ]; then
		echo "Downloading ${TARBALL_URL}..."
curl -sSL -o "${TARBALL}" "${TARBALL_URL}" || { echo "curl failed"; exit 1; }
	else
		echo "Using cached ${TARBALL}"
	fi

	if [ -n "${TARBALL_SHA256}" ] && command -v sha256sum >/dev/null 2>&1; then
		echo "${TARBALL_SHA256}	${TARBALL}" | sha256sum -c - || { echo "sha256 mismatch"; exit 1; }
	else
		echo "No checksum verification performed"
	fi
}

extract() {
	rm -rf "${WORK}" "${STAGING}"
	mkdir -p "${WORK}" "${STAGING}"
	xzcat "${TOP}/src/${TARBALL}" | gtar -C "${WORK}" -xf -
}

apply_patches() {
	if [ -d "${PATCHDIR}" ]; then
		for p in "${PATCHDIR}"/*.patch; do
			[ -f "$p" ] || continue
			echo "Applying patch $p"
			( cd "${WORK}/${NAME}" && patch -p1 < "$p" ) || { echo "patch failed"; exit 1; }
		done
	fi
}

build() {
	cd "${WORK}/${NAME}-${VER}"
	gmake CC="gcc ${CPPFLAGS} ${CFLAGS} ${LDFLAGS}" USRDIR="${PREFIX}" LDLIBS=-lintl
	gmake CC="gcc ${CPPFLAGS} ${CFLAGS} ${LDFLAGS}" USRDIR="${PREFIX}" LDLIBS=-lintl DESTDIR="${STAGING}" install
}

package() {
	sh "${TOP}/tools/make_svr4_pkg" \
		--staging "${STAGING}" \
		--pkgname "${PKGNAME}" \
		--version "${VER}" \
		--prefix "${PREFIX}" \
		--hooksdir "${HOOKSDIR}"
}

# allow running phases directly: ./recipe fetch|extract|apply_patches|build|package
if [ "$#" -gt 0 ]; then
  for phase in "$@"; do
    "$phase"
  done
fi


